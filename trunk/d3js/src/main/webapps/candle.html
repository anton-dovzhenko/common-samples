<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Simple D3 Dev Env</title>
    <style>
        body { font: 12px Arial;}

        path {
            stroke: steelblue;
            stroke-width: 2;
            fill: none;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: grey;
            stroke-width: 1;
            shape-rendering: crispEdges;
        }
        .axis .minor line {
            stroke: lightgrey;
            opacity: 0.7;
            stroke-dasharray: 2,2;
        }
        .tooltip {
            display: none;
            padding: 3px;
            position: absolute;
            background-color: rgba(192,192,192,0.8);
            height: 70px;
            width: 85px;
        }
    </style>
</head>
<body>
<svg id="chart"></svg>
<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript">

    function CandleStickWidget(spec) {
        var instance = {};

        instance.render = function(data) {
            var svg = d3.select(spec.element);
            svg.attr('height', spec.height + spec.margin.top + spec.margin.bottom);
            svg.attr('width', spec.width + spec.margin.left + spec.margin.right);


            var div = d3.select('body')
                    .append('div')
                    .attr('class', 'tooltip');

            var yMin = d3.min(data, function(d) {return d['LOW'];});
            var yMax = d3.max(data, function(d) {return d['HIGH'];});
            var xMin = d3.min(data, function(d) {return d['Time'];});
            var xMax = d3.max(data, function(d) {return d['Time'];});
            xMax = new Date(xMax);
            //FIXME: implement flexible interval incrementation
            xMax.setHours(xMax.getHours() + 1);

            var xScale = d3.time.scale().range([0, spec.width]).domain([xMin, xMax]);
            var yScale = d3.scale.linear().range([spec.height, 0]).domain([yMin, yMax]);

            var xAxis = d3.svg.axis().scale(xScale).orient('bottom').ticks(5)
                    .tickFormat(d3.time.format(spec.xAxisFormat)).tickSize(-spec.height);
            var yAxis = d3.svg.axis().scale(yScale).orient('left').ticks(5)
                    .tickFormat(d3.format(spec.yAxisFormat)).tickSize(-spec.width);

            var xWidth = (xScale(xMax) - xScale(xMin)) / data.length;

            //creating Axes
            var gy = svg.append('g')
                    .attr('class', 'y axis')
                    .attr('transform', 'translate(' + spec.margin.left + ', ' + spec.margin.top + ')')
                    .style('fill', 'steelblue')
                    .call(yAxis);
            gy.selectAll('g').filter(function(d) { return d; })
                    .classed("minor", true);

            var gx = svg.append('g')
                    .attr('class', 'x axis')
                    .attr('transform', 'translate(' + spec.margin.left  + ', ' + (spec.height + spec.margin.top) + ')')
                    .style('fill', 'steelblue')
                    .call(xAxis);
            gx.selectAll("g").filter(function(d) { return d; })
                    .classed("minor", true);

            //Creating candlesticks
            var chartContainer = svg.append('g')
                    .attr('transform', 'translate(' + spec.margin.left + ', ' + spec.margin.top + ')');
            var g = chartContainer.selectAll('g').data(data).enter()
                    .append('g')
                    .attr('transform', function(d) {return 'translate(' + xScale(d['Time']) + ', ' + yScale(d['HIGH'])+ ')'})
                    .attr('style', function(d) {return getCandleGroupStyle(d)});
            g.append('rect')
                    .attr('x', 0)
                    .attr('y', function(d) {return Math.min(yScale(d['FIRST']), yScale(d['LAST'])) - yScale(d['HIGH']);})
                    .attr('width', xWidth)
                    .attr('height', function(d) {
                        return Math.abs(yScale(d['FIRST']) - yScale(d['LAST']));
                    })
                    .attr('style', 'stroke:white;stroke-width:2;');

            g.append('line')
                    .attr('x1', xWidth / 2)
                    .attr('x2', xWidth / 2)
                    .attr('y1', 0)
                    .attr('y2', function(d) {return - yScale(d['HIGH']) + yScale(d['LOW']);})
                    .attr('stroke-width', 2);

            g.on('mouseover', function(d) {
                console.log(d3.select(this).attr('transform'));
                var candle = d3.select(this);
                candle.attr('style', 'fill:' + spec.highlightColor + ';stroke:' + spec.highlightColor + ';');
                var candleX = d3.transform(candle.attr('transform')).translate[0];
                var candleY = d3.transform(candle.attr('transform')).translate[1];
                div.style('display', 'block');
                if (candleX < 85) {
                    var left = (candleX + spec.margin.left + xWidth + 10);
                } else {
                    left = (candleX + spec.margin.left - 95);
                }
                div.style('left', left + 'px');
                div.style('top', (candleY + spec.margin.top) + 'px');
                div.html(d3.time.format(spec.xAxisFormat)(d['Time'])
                        + '<br/>High: ' + d['HIGH'] + '<br/>Low: ' + d['LOW']
                        + '<br/>First: ' + d['FIRST'] + '<br/>Last: ' + d['LAST']);
            });
            g.on('mouseout', function(d) {
                d3.select(this).attr('style', getCandleGroupStyle(d));
                div.style('display', 'none');
            });

            return instance;
        };

        function getCandleGroupStyle(d) {
            if (d['LAST'] >= d['FIRST']) {
                return 'fill:' + spec.upColor + ';stroke:' + spec.upColor + ';';
            } else {
                return 'fill:' + spec.downColor + ';stroke:' + spec.downColor + ';';
            }
        }

        return instance;
    }

    var widget = CandleStickWidget({element: '#chart'
        , width: 700
        , height: 400
        , margin: {top: 20, right: 20, bottom: 20, left: 50}
        , xAxisFormat: '%H:%M'
        , yAxisFormat: '.5f'
        , downColor: '#E00000'
        , upColor: '#009900'
        , highlightColor: '#FFD732'
    });

    d3.csv('aud_usd.csv', function(data) {
        var dateFormat = d3.time.format('%Y/%m/%d %H:%M:%S.%L');
        data.forEach(function(d) {
            d['HIGH'] = +d['HIGH'];
            d['LOW'] = +d['LOW'];
            d['LAST'] = +d['LAST'];
            d['FIRST'] = +d['FIRST'];
            d['Time'] = dateFormat.parse(d['Time']);
        });
        widget.render(data);
    });


</script>
</body>
</html>